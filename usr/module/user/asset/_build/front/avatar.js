!function(a){function b(b){var d=b.preview_url,f=0,g=0,i=e.uploadBoxSize,j=a("#fromUpload .avatar-preview-img"),k=0;h.removeClass("hide").attr("src",d),a.each(e.allSize,function(a,b){j.eq(k++).attr({src:d,"data-size":b})}),c&&c.destroy(),b.w>b.h?f=i:g=i,f?(g=i*b.h/b.w,h.css({width:i,height:g})):(f=i*b.w/b.h,h.css({width:f,height:i})),h.Jcrop({aspectRatio:1,bgOpacity:.5,onChange:function(b){var c=Math.round;j.each(function(){var d=a(this),e=parseInt(d.data("size"),10),h=e/b.w,i=e/b.h;d.css({width:c(h*f),height:c(i*g),marginLeft:c(-h*b.x),marginTop:c(-i*b.y)})})}},function(){c=this,c.result=b,this.setSelect([40,40,200,200])})}var c,d={el:a("#js-user-avatar"),$:function(a){return this.el.find(a)},cacheElements:function(){this.uploadBtn=this.$(".avatar-upload-btn")},init:function(){this.config=this.el.data("config"),this.cacheElements()}};d.init();var e=d.config,f=(e.allSize,d.uploadBtn),g=d.$(".js-save"),h=d.$(".avatar-upload-image"),i=d.$("[name=email]"),j=d.$("[name=repository-avatar]"),k=/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,6}$/,l=function(){var b={};return function(c,d){return d&&(c=c+"?"+a.param(d)),b[c]?b[c]:b[c]=a.get(c)}}();new ajaxUpload(f,{action:e.urlRoot+"upload?fake_id="+e.fake_id,name:"upload",format:e.format,json:!0,start:function(){f.val(e.processText)},done:function(a){a.status?(f.trigger("remove"),d.$(".avatar-upload-hit").remove(),g.removeAttr("disabled"),b(a.data)):(alert(a.message),f.val(e.uploadText))}}),d.$(".js-cancel").click(function(){location.href=location.href}),d.$(".avatar-source-nav").on("shown",function(){var b=a(this).data("source");g.attr("data-source",b),"upload"==b?g.attr("disabled","disabled"):g.removeAttr("disabled")}).filter("[data-source="+e.source+"]").tab("show"),g.click(function(){var b=g.attr("data-source"),f={};if(g.attr("disabled","disabled"),"upload"==b){var h=c.result,i=h.w>h.h?h.w/300:h.h/300;a.each(c.tellScaled(),function(a,b){f[a]=Math.round(b*i)}),f.avatar=h.preview_url,f.fake_id=e.fake_id}else"gravatar"==b?f.email=a.trim(d.$("[name=email]").val()):"select"==b&&(f.name=d.$("[name=repository-avatar]:checked").val());f.source=b,a.post(e.urlRoot+"save",f).done(function(b){b=a.parseJSON(b),b.status?window.location.reload():(g.removeAttr("disabled"),alert(b.message))})}),i.blur(function(){var b=a.trim(i.val());b&&k.test(b)&&l(e.urlRoot+"gravatar",{email:b}).done(function(b){b=a.parseJSON(b);var c=a("#fromGravatar .avatar-preview-img"),d=b.preview_url,f=0,g=function(a){return d.replace(/(s=).*?(&)/,"$1"+a+"$2")};a.each(e.allSize,function(a,b){c.eq(f++).attr("src",g(b))})})}),j.click(function(){var b=a(this).val(),c=a("#formRepository .avatar-preview-img");l(e.urlRoot+"repository",{name:b}).done(function(b){if(b=a.parseJSON(b),b.status){var d,f=0;a.each(e.allSize,function(a){d=b.dirname+"/"+a+"."+b.ext,c.eq(f++).attr("src",d)})}else alert(b.message)})}),"select"==e.source?j.filter("[value="+e.filename+"]").attr("checked","checked"):j.eq(0).attr("checked","checked")}(jQuery);