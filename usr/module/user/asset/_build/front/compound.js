!function(a){function b(a,b){if(a.find(".error").removeClass("error").find(".help-inline").hide(),b)for(var c in b){var d=[];for(var e in b[c])d.push(b[c][e]);a.find("[name="+c+"]").parents(".control-group").addClass("error").find(".help-inline").show().html(d.join(","))}}var c=a("#user-js-compound").data("config"),d=Backbone.Collection.extend({initialize:function(){this.on("remove",this.resetSet)},resetSet:function(){this.forEach(function(a,b){a.set("set",b)})}}),e=Backbone.View.extend({el:a("#user-js-compound"),initialize:function(){this.listView=new g({el:this.$(".user-info-list"),collection:new d(c.compounds)}),this.addView=new h({el:this.$(".user-info-add")}),this.listView.parentView=this,this.addView.parentView=this}}),f=Backbone.View.extend({className:"user-info-item",events:{"click .js-edit":"toggleEdit","click .js-cancel":"render","submit form":"submit","click .js-delete":"fadeRemove"},initialize:function(){this.listenTo(this.model,"change",this.render)},template:_.template(a("#field-template").html()),render:function(){return this.$el.removeClass("user-info-item-edit"),this.$el.html(this.template(this.model.toJSON())),this.el},toggleEdit:function(){var b=this,d=this.$(".user-info-body");return this.$el.hasClass("user-info-item-edit")?(this.render(),void 0):(a.get(c.urlRoot+"compoundForm",this.getParams()).done(function(a){b.$el.addClass("user-info-item-edit"),d.html(a)}),void 0)},submit:function(d){var e=this,f=this.$("form");d.preventDefault(),a.post(c.urlRoot+"compoundForm?"+a.param(this.getParams()),f.serialize()).done(function(c){c=a.parseJSON(c),c.status?(e.model.set(c.data),e.model.hasChanged()||e.render()):b(f,c.message)})},fadeRemove:function(){if(confirm(c.deleteConfirm)){var b=this,d=this.model.collection;a.post(c.urlRoot+"deleteCompound",this.getParams()).done(function(c){c=a.parseJSON(c),c.status&&b.$el.fadeOut(250,function(){b.remove(),d.remove(b.model)})})}},getParams:function(){return{groupId:c.groupId,set:this.model.get("set")}}}),g=Backbone.View.extend({initialize:function(){this.render(),this.sortable(),this.listenTo(this.collection,"add",this.addOne)},addOne:function(a){this.$el.append(new f({model:a}).render())},render:function(){this.$el.html(""),this.collection.forEach(this.addOne,this)},sortable:function(){var b=this;this.$el.sortable({handle:".user-info-header",items:".user-info-item",start:function(a,b){b.item.data("start",b.item.index())},update:function(d,e){var f=e.item.data("start"),g=e.item.index(),h=b.collection.models,i=[];h.splice(g,0,h.splice(f,1)[0]);for(var j=h.length,k=0;j>k;k++)_.each(h,function(a,b){a.get("set")==k&&i.push(b)});a.post(c.urlRoot+"editCompoundSet",{groupId:c.groupId,set:i.join(",")}).done(function(c){c=a.parseJSON(c),c.status&&b.collection.resetSet()})}})}}),h=Backbone.View.extend({events:{"submit form":"submit"},submit:function(d){var e=this.$("form"),f=this;d.preventDefault(),a.post(c.urlRoot+"addCompoundItem",e.serialize()).done(function(c){c=a.parseJSON(c),c.status?(f.parentView.listView.collection.push(c.data),e.find("[disabled=disabled]").removeAttr("disabled"),b(e),e[0].reset()):b(e,c.message)})}});new e}(jQuery);